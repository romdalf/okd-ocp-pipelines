= OKD/OCP Jenkins Pipeline Examples
:toc: 
:toc-placement!:

toc::[]

== Prerequesites 

- a working OKD/OCP (see minishift or crc for test environment)
- a project namespace
- a jenkins instance deployed within the project namespace (not for Basic NGINX build)

== Basic NGINX build 

This example shows a basic external webhook from github after building a NGINX instance with the
"basic-html-page" directory. 

To use it, you can do the following from the Developer view:


[link=https://raw.githubusercontent.com/rovandep/ocp-nodejs-pipeline/master/images/basic-html-page-01.gif]
image::basic-html-page-01.gif[]

- click "Project" and "Create Project"
- create 2 projects, one for dev and one for production
- select one of the created projects
- click "+Add"
- click "From Catalog"
- in the search field type "nginx"
- select "Nginx HTTP server and a reverse proxy" & click "Instantiate Template"
- fill in "Name" with a meaningful unique one
- copy/paste the git repo url in "Git Repository URL"
- fill in "Git Reference" with a branch (either master or dev related to your project)
- fill in a "easy" secret for Github and Generic webhook (for testing only!)
- repeat the above steps for the second project and choose a the second branch for the "Git Reference"

At the end, check in Topology or in Builds, you should have 2 pods with the related index page from his branch. Click the pod in Topology and checking the tab "Resources" will provide you with the external route to access the page.

Setup the Webhooks

- for each projects, in Builds, Build Config Details, Ovreview, click "Click URL with Secret"
- for the dev branch, in GitHub settings, Webhooks, setup the dev webhook URL with JSON payload and select "Pushes" in the option "Let me select individual events"; this will kick in a new build when developer will push changes to the dev branch of the repo
- for the master branch, in GitHub, settings, Webhooks, setup the prd webhook URL with JSON payload and select "Pull Requests" and "Pushes" in the option "Let me select individual events"; this will kick in a new build when developer will merge and push from dev to master branch of the repo

== Simple nodejs example

This example is a quick and dirty way to show the usage of a buildconfig YAML file to create a 
Build Config within OKD/OCP that will use a Jenkins instance within the namespace to build
a simple ephemeral nodejs & mongodb instances with a working external route. 

To use it, it can be done through CLI: 
``` 
# oc create -f https://raw.githubusercontent.com/rovandep/ocp-nodejs-pipeline/master/nodejs-pipeline.yaml
# oc get buildconfig
NAME                     TYPE              FROM   LATEST
nodejs-pipeline          JenkinsPipeline          6

# oc start-build nodejs-pipeline
# oc get build
NAME                       TYPE              FROM          STATUS     STARTED          DURATION
nodejs-pipeline-1          JenkinsPipeline                 Complete   13 minutes ago   
``` 

It can be done through GUI too:
or from the project namespace Status or in Build Configs, click "Add, Import YAML" and copy/paste 
the contain of "nodejs-pipeline.yaml"

Once added, you can click the "Start Build" which will redirect you to the Build details. From that page,
the Jenkins pipeline job overview can be observed or click on "View Logs" to open Jenkins. 
